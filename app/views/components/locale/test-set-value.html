<div class="page-container scrollable" id="maincontent" role="main">
  <div class="row">
    <div class="two columns">
      <div class="field">
        <label for="locale-field">Current Locale</label>
        <input class="input-mm" id="locale-field" readonly/>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="two columns">
      <div class="field">
        <label for="input-date-field-yyyyMMdd">Beginning Database Value (en-US)</label>
        <input class="input-sm" id="input-date-field-yyyyMMdd" readonly/>
      </div>
      <div class="field">
        <label for="date-field-yyyyMMdd" class="label">Date Field</label>
        <input id="date-field-yyyyMMdd" class="datepicker" type="text">
      </div>
      <div class="field">
        <label for="output-date-field-yyyyMMdd">Transformed Database Value (en-US)</label>
        <input class="input-sm" id="output-date-field-yyyyMMdd" readonly/>
      </div>
    </div>

    <div class="two columns">
      <div class="field">
        <label for="input-date-field-MMdd">Beginning Database Value (en-US)</label>
        <input class="input-sm" id="input-date-field-MMdd" readonly/>
      </div>
      <div class="field">
        <label for="date-field-MMdd" class="label">MMMMdd Field</label>
        <input id="date-field-MMdd" class="datepicker" type="text">
      </div>
      <div class="field">
        <label for="output-date-field-MMdd">Transformed Database Value (en-US)</label>
        <input class="input-sm" id="output-date-field-MMdd" readonly/>
      </div>
    </div>

    <div class="two columns">
      <div class="field">
        <label for="input-date-field-yyyyMM">Beginning Database Value (en-US)</label>
        <input class="input-sm" id="input-date-field-yyyyMM" readonly/>
      </div>
      <div class="field">
        <label for="date-field-yyyyMM" class="label">yyyyMMMM Field</label>
        <input id="date-field-yyyyMM" class="datepicker" type="text">
      </div>
      <div class="field">
        <label for="output-date-field-yyyyMM">Transformed Database Value (en-US)</label>
        <input class="input-sm" id="output-date-field-yyyyMM" readonly/>
      </div>
    </div>

    <div class="two columns">
      <div class="field">
        <label for="input-date-field-yyyy">Beginning Database Value (en-US)</label>
        <input class="input-sm" id="input-date-field-yyyy" readonly/>
      </div>
      <div class="field">
        <label for="date-field-yyyy" class="label">yyyy Field</label>
        <input id="date-field-yyyy" class="datepicker" type="text">
      </div>
      <div class="field">
        <label for="output-date-field-yyyy">Transformed Database Value (en-US)</label>
        <input class="input-sm" id="output-date-field-yyyy" readonly/>
      </div>
    </div>

    <div class="two columns">
      <div class="field">
        <label for="input-date-field-timestamp">Beginning Database Value (en-US)</label>
        <input class="input-md" id="input-date-field-timestamp" readonly/>
      </div>
      <div class="field">
        <label for="date-field-timestamp" class="label">timestamp Field</label>
        <input id="date-field-timestamp" class="datepicker input-md" type="text">
      </div>
      <div class="field">
        <label for="output-date-field-timestamp">Transformed Database Value (en-US)</label>
        <input class="input-md" id="output-date-field-timestamp" readonly/>
      </div>
    </div>
  </div>

  <script>
    $('body').on('initialized', function () {
      $('#locale-field').val(Soho.Locale.currentLocale.name + ', ' + Soho.Locale.calendar().name);

      var model = {
        yyyyMMdd: {
          dataPattern:      'yyyyMMdd',
          displayPattern:   Soho.Locale.calendar().dateFormat.short,
          dbValue:          '20200229',
          fieldId:          'date-field-yyyyMMdd',
          options: {
            mode: 'standard',
            dateFormat: Soho.Locale.calendar().dateFormat.short,
            showMonthYearPicker: true
          }
        },
        MMdd: {
          dataPattern:      'MMdd',
          displayPattern:   Soho.Locale.calendar().dateFormat.month,
          dbValue:          '0229',
          fieldId:          'date-field-MMdd',
          options: {
            mode: 'standard',
            dateFormat: Soho.Locale.calendar().dateFormat.month
          }
        },
        yyyyMM: {
          dataPattern:      'yyyyMM',
          displayPattern:   Soho.Locale.calendar().dateFormat.year,
          dbValue:          '202002',
          fieldId:          'date-field-yyyyMM',
          options: {
            mode: 'standard',
            dateFormat: Soho.Locale.calendar().dateFormat.year,
            showMonthYearPicker: true,
            hideDays: true
          }
        },
        yyyy: {
          dataPattern:      'yyyy',
          displayPattern:   'yyyy',
          dbValue:          '2020',
          fieldId:          'date-field-yyyy',
          options: {
            mode: 'standard',
            dateFormat: 'yyyy',
            showMonthYearPicker: true,
            hideDays: true
          }
        },
        timestamp: {
          dataPattern:      'yyyyMMddHHmmss',
          displayPattern:   Soho.Locale.calendar().dateFormat.short + ' ' + Soho.Locale.calendar().dateFormat.timestamp,
          dbValue:          '20200229104530',
          fieldId:          'date-field-timestamp',
          options: {
            mode: 'standard',
            dateFormat: Soho.Locale.calendar().dateFormat.short + ' ' + Soho.Locale.calendar().dateFormat.timestamp,
            showMonthYearPicker: true,
            showTime: true,
            useCurrentTime: true
          }
        }
      };

      // AFTER
      // transformation of date value from database format (en-US) to current locale for display
      var modelKeys = Object.keys(model)
      .forEach( (key) => {
        var modelItem = model[key];

        var datepicker = $('#' + modelItem.fieldId).datepicker(modelItem.options);
        $('#input-' + modelItem.fieldId).val(modelItem.dbValue);

        var fromPattern = modelItem.dataPattern;
        var toPattern = modelItem.displayPattern;

        var parseDateOptions = {
          // pattern: toPattern,
          dateFormat: fromPattern,
          locale: 'en-US',
          calendarName: 'gregorian'
        };
        var date = Soho.Locale.parseDate(modelItem.dbValue, parseDateOptions, false);

        // dateTimeDisplayRule
        var formatDateOptions = {
          pattern: toPattern,
          fromGregorian: (Soho.Locale.calendar().name === 'islamic-umalqura') ? true : undefined,
          // locale: 'en-US',
          // calendarName: 'gregorian'
        };
        var value = Soho.Locale.formatDate(date, formatDateOptions);

        datepicker.data('datepicker').setValue(value);
        // datepicker.data('datepicker').setValue(date);

        console.log([modelItem.fieldId + ' value transformed', modelItem.dbValue, value]);
      });

      $('.datepicker').on('change', function (e, args) {
        var key = e.currentTarget.id.substr(e.currentTarget.id.lastIndexOf('-')+1);
        var modelItem = model[key];

        // transformation of date value in current locale format to database format (en-US)
        var elemValue = $('#' + modelItem.fieldId).data('datepicker').element.val();

        var fromPattern = modelItem.displayPattern;
        var toPattern = modelItem.dataPattern;

        var parseDateOptions = {
          // pattern: toPattern,
          dateFormat: fromPattern,
          // locale: 'en-US',
          // calendarName: 'gregorian'
        };
        var date = Soho.Locale.parseDate(elemValue, parseDateOptions, false);

        // dateTimeDataRule
        var formatDateOptions = {
          pattern: toPattern,
          toGregorian: (Soho.Locale.calendar().name === 'islamic-umalqura') ? true : undefined,
          locale: 'en-US',
          calendarName: 'gregorian'
        };
        var value = Soho.Locale.formatDate(date, formatDateOptions);

        $('#output-' + modelItem.fieldId).val(value);

        console.log([modelItem.fieldId + '.onchange value transformed', elemValue, value]);

      });
    });

  </script>

</div>
